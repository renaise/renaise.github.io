---
import Base from '../layouts/Base.astro';
import ProjectsSidebar from '../components/ProjectsSidebar.astro';
import ProfilesSidebar from '../components/ProfilesSidebar.astro';
import { projectsExpanded, labProjects } from '../data/projects-expanded';

// Carousel order: lighthouse → flora → soot → biota → aputure → osmosis
const allowedProjects = ['lighthouse', 'flora', 'soot', 'biota', 'aputure', 'osmosis'];

// Hero assets for each project (videos and images)
const heroAssets: Record<string, { url: string; type: 'video' | 'image' }> = {
  lighthouse: { url: 'https://renaise.codexfoundry.com/lighthouse_brand.png', type: 'image' },
  flora: { url: 'https://renaise.codexfoundry.com/flora_still.gif', type: 'image' },
  soot: { url: 'https://renaise.codexfoundry.com/platform_soot.mp4', type: 'video' },
  biota: { url: 'https://renaise.codexfoundry.com/biota_cover.mp4', type: 'video' },
  aputure: { url: 'https://renaise.codexfoundry.com/Aputure_Site.mp4', type: 'video' },
  osmosis: { url: 'https://renaise.codexfoundry.com/OsmosisHeader_3.mp4', type: 'video' },
};

// Map expanded projects to sidebar format (filtered)
const projects = projectsExpanded
  .filter(p => allowedProjects.includes(p.id))
  .sort((a, b) => allowedProjects.indexOf(a.id) - allowedProjects.indexOf(b.id))
  .map(p => ({
  id: p.id,
  name: p.name,
  icon: p.icon,
  href: p.stage.href,
  description: p.stage.description,
  tags: p.stage.tags,
  serviceSuite: p.serviceSuite,
  category: p.stage.category,
  year: p.stage.year,
  role: p.stage.role,
  outcome: p.stage.outcome,
  leadVertical: p.serviceSuite[0] || 'Design',
  hasLabel: p.id === 'nove',
}));

// Social profiles - right sidebar (order matches screenshot)
const profiles = [
  { name: 'LinkedIn', icon: '/assets/socials/linkedin.png', href: 'https://www.linkedin.com/in/renaise-kim-408641123/' },
  { name: 'Artifice', icon: '/assets/socials/artifice.png', href: 'https://studioartifice.com' },
  { name: 'X', icon: '/assets/socials/x.png', href: 'https://x.com/reallynaise' },
  { name: 'Cosmos', icon: '/assets/socials/cosmos.png', href: 'https://www.cosmos.so/renaise' },
  { name: 'Toilet', icon: '/assets/socials/toilet.png', href: '#' },
];

// Top navigation items
const navItems = [
  { label: 'INDEX', href: '#', icon: true },
  { label: 'RESEARCH', href: '#' },
];
---

<Base title="RENAISE (A)">
  <div id="page-container" class="relative min-h-screen bg-[#111111] overflow-hidden" style="transition: background 0.3s ease;">

    <!-- Dot grid background (32px visual grid) -->
    <div class="dot-grid fixed inset-0 z-0 pointer-events-none" aria-hidden="true">
      <svg width="100%" height="100%">
        <pattern id="dots" x="0" y="0" width="32" height="32" patternUnits="userSpaceOnUse">
          <circle cx="16" cy="16" r="1" fill="currentColor" />
        </pattern>
        <rect width="100%" height="100%" fill="url(#dots)" />
      </svg>
    </div>

    <!-- Hero Background - project asset (grid-aligned) -->
    <div class="hero-bg fixed inset-0 z-[2] pointer-events-none">
      <div id="hero-media" class="hero-media absolute overflow-hidden rounded-sm">
        <!-- Video element (hidden by default, shown for video assets) -->
        <video id="hero-video" class="absolute inset-0 w-full h-full object-cover hidden" autoplay muted loop playsinline></video>
        <!-- Image element (shown for image assets) -->
        <img id="hero-image" class="absolute inset-0 w-full h-full object-cover" src="https://renaise.codexfoundry.com/lighthouse_brand.png" alt="" />
      </div>
    </div>

    <!-- Hero assets data for JS + preload -->
    <script is:inline define:vars={{ heroAssets }}>
      window.heroAssets = heroAssets;

      // Preload all hero assets
      Object.values(heroAssets).forEach(asset => {
        if (asset.type === 'video') {
          const link = document.createElement('link');
          link.rel = 'preload';
          link.as = 'video';
          link.href = asset.url;
          document.head.appendChild(link);

          // Also create a hidden video element to buffer
          const video = document.createElement('video');
          video.preload = 'auto';
          video.muted = true;
          video.src = asset.url;
          video.load();
        } else {
          const img = new Image();
          img.src = asset.url;
        }
      });
    </script>

    <!-- Grid-aligned frame (snaps to 32px dot grid) -->
    <div class="fixed inset-0 z-[3] pointer-events-none">
      <div id="grid-frame" class="absolute" style="width: 896px; height: 544px;">
        <!-- Top line -->
        <div class="absolute top-0 left-0 right-0 h-px bg-white/20"></div>
        <!-- Bottom line -->
        <div class="absolute bottom-0 left-0 right-0 h-px bg-white/20"></div>
        <!-- Left line -->
        <div class="absolute top-0 bottom-0 left-0 w-px bg-white/20"></div>
        <!-- Right line -->
        <div class="absolute top-0 bottom-0 right-0 w-px bg-white/20"></div>
        <!-- Corner dots (larger, on grid intersections) -->
        <div class="absolute -top-[3px] -left-[3px] w-[7px] h-[7px] rounded-full bg-white/50"></div>
        <div class="absolute -top-[3px] -right-[3px] w-[7px] h-[7px] rounded-full bg-white/50"></div>
        <div class="absolute -bottom-[3px] -left-[3px] w-[7px] h-[7px] rounded-full bg-white/50"></div>
        <div class="absolute -bottom-[3px] -right-[3px] w-[7px] h-[7px] rounded-full bg-white/50"></div>
      </div>
    </div>

    <!-- RENAISE Watermark - Figma: 1526px width, centered with -21px offset -->
    <div class="fixed bottom-0 left-1/2 z-[1] pointer-events-none select-none" style="transform: translateX(calc(-50% - 21px));">
      <img
        src="/assets/watermark.svg"
        alt=""
        class="watermark w-[1600px] max-w-[95vw] max-h-[40vh] object-contain"
      />
    </div>

    <!-- Top Left: LAB + STAGE toggle - Figma: 196×55, 2% white, 12px radius -->
    <div class="fixed top-4 left-4 z-20 flex items-center justify-center gap-1 nav-bar w-[196px] h-[55px] rounded-[12px] bg-white/[0.02]">
      <button id="lab-tab" class="nav-tab flashlight-tab px-5 py-2.5" data-view="lab">
        <span class="tab-bg"></span>
        <span class="tab-glow"></span>
        <span class="tab-content">LAB</span>
      </button>
      <button id="stage-tab" class="nav-tab flashlight-tab nav-tab-active px-5 py-2.5" data-view="stage">
        <span class="tab-bg"></span>
        <span class="tab-glow"></span>
        <span class="tab-content">STAGE</span>
      </button>
    </div>

    <!-- Top Center: Bio text -->
    <div class="bio-section fixed top-4 left-1/2 -translate-x-1/2 z-20">
      <p class="bio-text">RENAISE IS A VISUAL PRODUCER + PROTOTYPER WITH 8 YEARS OF EXPERIENCE DESIGNING IDENTITIES AND INTUITIVE PRODUCTS FOR BRANDS IN CONSUMER TECH AND MEDIA. STUDIO PARTNER AT <a href="https://studioartifice.com" target="_blank" rel="noopener noreferrer" class="artifice-link"><span class="italic">STUDIO ARTIFICE</span></a><br /><img src="/assets/artifice-a.png" alt="" class="artifice-mark" /> + CO-DIRECTOR AT <a href="https://artificenyc.com" target="_blank" rel="noopener noreferrer" class="artifice-link"><span class="italic">ARTIFICE NYC</span> <img src="/assets/artifice-mark.png" alt="" class="artifice-mark" /></a></p>
    </div>

    <!-- Top Right: Ellipsis menu button -->
    <div class="fixed top-4 right-4 z-30">
      <button id="ellipsis-menu" class="ellipsis-btn w-12 h-12 rounded-full flex items-center justify-center transition-all duration-200">
        <svg width="20" height="4" viewBox="0 0 20 4" fill="currentColor">
          <circle cx="2" cy="2" r="2" />
          <circle cx="10" cy="2" r="2" />
          <circle cx="18" cy="2" r="2" />
        </svg>
      </button>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- STAGE VIEW -->
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <div id="stage-view" class="stage-view relative z-10">
      <!-- Projects Sidebar - Left -->
      <ProjectsSidebar projects={projects} />

      <!-- Profiles Sidebar - Right -->
      <ProfilesSidebar profiles={profiles} />

      <!-- Center Content Area - receives mouse events -->
      <main id="center-stage" class="relative z-20 min-h-screen flex flex-col items-center justify-center">

        <!-- Single Platform - Rotating Project Icon -->
        <div id="project-platform" class="relative z-20 w-56 h-56 flex items-center justify-center transition-all duration-500">
          <img id="preview-icon" src="/assets/projects/biota.png" alt="" class="w-36 h-36 object-contain transition-all duration-300 opacity-75" />
        </div>

      </main>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <!-- LAB VIEW -->
    <!-- ═══════════════════════════════════════════════════════════════════════════ -->
    <div id="lab-view" class="lab-view hidden absolute inset-0 z-10 flex flex-col">
      <!-- Lab dot grid (black dots) -->
      <div class="lab-dot-grid absolute inset-0 z-0 pointer-events-none" aria-hidden="true">
        <svg width="100%" height="100%">
          <pattern id="dots-lab-view" x="0" y="0" width="32" height="32" patternUnits="userSpaceOnUse">
            <circle cx="16" cy="16" r="1" fill="rgba(0,0,0,0.2)" />
          </pattern>
          <rect width="100%" height="100%" fill="url(#dots-lab-view)" />
        </svg>
      </div>
      <!-- Horizontal scrolling row of large square cards -->
      <div class="relative z-10 flex-1 flex items-center px-6 overflow-x-auto overflow-y-hidden">
        <div class="flex gap-0">
          {labProjects.map((p, i) => (
            <a
              href={`/lab/${p.id}`}
              class="lab-card flex-shrink-0 w-[380px] h-[380px] border border-white/20 flex flex-col p-6 hover:bg-white/10 transition-colors"
            >
              <!-- Top row: Number + Year -->
              <div class="flex items-start justify-between">
                <span class="w-8 h-8 flex items-center justify-center text-[13px] text-white/60 border border-white/30 rounded-full">
                  {i + 1}
                </span>
                <span class="text-[13px] text-white/50 tracking-wide">
                  {p.stage.year}
                </span>
              </div>

              <!-- Center: Title -->
              <h2 class="text-[24px] md:text-[28px] text-white/90 font-medium uppercase tracking-wide text-center leading-tight my-auto px-4">
                {p.lab.title}
              </h2>

              <!-- Bottom: Service tags -->
              <div class="flex items-center justify-center gap-3 flex-wrap">
                {p.serviceSuite.map((service, idx) => (
                  <span class="flex items-center gap-3 text-[11px] uppercase tracking-widest text-white/50">
                    {idx > 0 && <span class="w-1.5 h-1.5 rounded-full bg-white/50"></span>}
                    {service}
                  </span>
                ))}
              </div>
            </a>
          ))}
        </div>
      </div>
    </div>

    <!-- Bottom Left: CONTACT button - aligned under Projects dock -->
    <div class="fixed bottom-4 left-4 z-30 nav-bar w-[116px]">
      <a href="mailto:hello@renaise.com" class="nav-tab flashlight-tab w-full flex items-center justify-center py-2.5">
        <span class="tab-bg"></span>
        <span class="tab-glow"></span>
        <span class="tab-content">CONTACT</span>
      </a>
    </div>

    <!-- Bottom Center: CTA + Scrolling text pill (50% of mountain div width) -->
    <div class="fixed bottom-4 left-1/2 z-20 w-[35%] max-w-[475px] -translate-x-1/2">
      <div class="marquee-pill h-[40px] flex items-center rounded-full bg-white/[0.04] border border-white/[0.08] backdrop-blur-md overflow-hidden">
        <!-- CTA Section (30%) - links to active project's lab -->
        <a id="lab-cta" href="/lab" class="flex-shrink-0 h-full px-4 flex items-center justify-center bg-white/[0.03] hover:bg-white/[0.08] transition-colors border-r border-white/[0.08]">
          <span class="text-[10px] uppercase tracking-wider text-white/70 whitespace-nowrap">See process in Lab</span>
        </a>
        <!-- Scrolling text (70%) -->
        <div class="marquee-container overflow-hidden flex-1 relative px-4">
          <span id="marquee-content" class="marquee-content text-[11px] uppercase tracking-wider text-white/50">
            <!-- Dynamic content set by JS based on active project -->
          </span>
        </div>
      </div>
    </div>

    <!-- Bottom Right: ABOUT button - aligned under Profiles dock -->
    <div class="fixed bottom-4 right-4 z-20 nav-bar w-[116px]">
      <button id="about-trigger" class="nav-tab flashlight-tab w-full flex items-center justify-center py-2.5">
        <span class="tab-bg"></span>
        <span class="tab-glow"></span>
        <span class="tab-content">ABOUT</span>
      </button>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="fixed inset-0 z-50 hidden">
      <!-- Backdrop -->
      <div class="about-backdrop absolute inset-0 bg-[#111111]"></div>

      <!-- Content -->
      <div class="about-content relative z-10 flex flex-col items-center justify-center min-h-screen px-6 py-12">
        <!-- Header -->
        <div class="absolute top-6 left-0 right-0 text-center">
          <span class="text-[13px] tracking-[0.05em] text-white/50 uppercase">About</span>
        </div>

        <!-- Video -->
        <div class="about-video-container w-full max-w-[480px] aspect-[4/5] rounded-2xl overflow-hidden mb-8">
          <video
            class="w-full h-full object-cover"
            autoplay
            loop
            muted
            playsinline
          >
            <source src="/assets/about-video.mp4" type="video/mp4" />
          </video>
        </div>

        <!-- Bio Info -->
        <div class="text-center space-y-2">
          <h2 class="text-[28px] font-light tracking-wide text-white uppercase">Renaise Kim</h2>
          <p class="text-[13px] tracking-[0.08em] text-white/60 uppercase">Visual Producer + Prototyper</p>
          <p class="text-[13px] tracking-[0.08em] text-white/40 uppercase">8 years experience. Based in NYC.</p>
          <p class="text-[13px] tracking-[0.08em] text-white/40 uppercase">Studio Partner at <a href="https://studioartifice.com" target="_blank" rel="noopener" class="hover:text-white/70 transition-colors">Studio Artifice</a></p>
        </div>

        <!-- Profile Links -->
        <div class="flex items-center gap-6 mt-8">
          <a href="https://www.linkedin.com/in/renaise-kim-408641123/" target="_blank" rel="noopener" class="about-profile-link">
            <img src="/assets/socials/linkedin.png" alt="LinkedIn" class="w-6 h-6 opacity-50 hover:opacity-100 transition-opacity" />
          </a>
          <a href="https://x.com/reallynaise" target="_blank" rel="noopener" class="about-profile-link">
            <img src="/assets/socials/x.png" alt="X" class="w-6 h-6 opacity-50 hover:opacity-100 transition-opacity" />
          </a>
          <a href="https://www.cosmos.so/renaise" target="_blank" rel="noopener" class="about-profile-link">
            <img src="/assets/socials/cosmos.png" alt="Cosmos" class="w-6 h-6 opacity-50 hover:opacity-100 transition-opacity" />
          </a>
          <a href="https://studioartifice.com" target="_blank" rel="noopener" class="about-profile-link">
            <img src="/assets/socials/artifice.png" alt="Studio Artifice" class="w-6 h-6 opacity-50 hover:opacity-100 transition-opacity" />
          </a>
        </div>

        <!-- Close Button -->
        <button id="about-close" class="absolute bottom-6 left-1/2 -translate-x-1/2 nav-tab flashlight-tab px-8 py-2.5">
          <span class="tab-bg"></span>
          <span class="tab-glow"></span>
          <span class="tab-content text-[13px] tracking-[0.05em] uppercase">Close</span>
        </button>
      </div>
    </div>

  </div>
</Base>

<style>
  /* ——— Ellipsis menu button ——— */
  .ellipsis-btn {
    background: rgba(30, 30, 30, 0.9);
    color: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .ellipsis-btn:hover {
    background: rgba(50, 50, 50, 0.95);
    color: rgba(255, 255, 255, 0.9);
  }

  /* Light mode for LAB view */
  .ellipsis-btn.light {
    background: rgba(255, 255, 255, 0.9);
    color: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .ellipsis-btn.light:hover {
    background: rgba(255, 255, 255, 1);
    color: rgba(0, 0, 0, 0.9);
  }

  /* ——— Layout & background ——— */
  .dot-grid {
    color: rgba(255, 255, 255, 0.45);
    opacity: 1;
    transition: color 0.3s ease;
  }

  /* Bio section typography - centered */
  .bio-section {
    display: flex;
    justify-content: center;
  }

  .bio-text {
    font-family: 'ABC Diatype Mono', 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    font-weight: 400;
    font-size: 14px;
    line-height: 1.5;
    letter-spacing: 0.02em;
    color: rgba(255, 255, 255, 0.9);
    text-align: center;
    text-transform: uppercase;
    max-width: 720px;
  }

  .bio-text .italic {
    font-style: italic;
  }

  /* Artifice links in bio */
  .artifice-link {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease, opacity 0.2s ease;
    pointer-events: auto;
  }

  .artifice-link:hover {
    color: rgba(255, 255, 255, 1);
  }

  .artifice-link:hover .artifice-mark {
    opacity: 1;
  }

  /* Artifice NYC mark - matches text */
  .artifice-mark {
    display: inline-block;
    height: 14px;
    width: auto;
    vertical-align: middle;
    margin-left: 3px;
    opacity: 0.6;
    transition: opacity 0.2s ease;
  }

  .watermark {
    filter: brightness(0) invert(1);
    opacity: 0.5;
  }


  .hero-image {
    opacity: 0.5;
    filter: grayscale(30%);
  }

  .glass-panel {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 20px 40px rgba(0, 0, 0, 0.3);
  }

  /* Figma sidebar specs: layered backgrounds with blend modes */
  .profiles-sidebar {
    background:
      linear-gradient(0deg, rgba(94, 94, 94, 0.2) 0%, rgba(94, 94, 94, 0.2) 100%),
      linear-gradient(0deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.2) 100%);
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
  }

  .projects-sidebar {
    background:
      linear-gradient(0deg, rgba(94, 94, 94, 0.2) 0%, rgba(94, 94, 94, 0.2) 100%),
      linear-gradient(0deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.2) 100%);
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
  }

  /* ——— Nav ——— */
  .nav-bar {
    font-family: 'Helvetica Now Display', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 400;
  }

  /* ——— Button System ——— */
  /* Default: dark fill, muted text */
  .nav-tab {
    position: relative;
    min-width: 88px;
    height: 43px;
    font-size: 13px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    overflow: hidden;
    background: rgba(40, 40, 40, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.2s ease;
  }

  /* Hover: glassmorphism with inner glow */
  .nav-tab:hover {
    color: rgba(255, 255, 255, 0.9);
    background: linear-gradient(
      180deg,
      rgba(80, 80, 80, 0.6) 0%,
      rgba(60, 60, 60, 0.5) 30%,
      rgba(45, 45, 45, 0.6) 100%
    );
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow:
      inset 0 1px 1px rgba(255, 255, 255, 0.15),
      0 2px 8px rgba(0, 0, 0, 0.3);
  }

  /* Active State - strong glass effect with top highlight */
  .nav-tab-active {
    color: rgba(255, 255, 255, 1);
    background: linear-gradient(
      180deg,
      rgba(100, 100, 100, 0.5) 0%,
      rgba(70, 70, 70, 0.4) 20%,
      rgba(50, 50, 50, 0.5) 60%,
      rgba(40, 40, 40, 0.6) 100%
    );
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow:
      inset 0 1px 2px rgba(255, 255, 255, 0.2),
      inset 0 0 20px rgba(255, 255, 255, 0.05),
      0 4px 16px rgba(0, 0, 0, 0.4);
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
  }

  .nav-tab-active:hover {
    background: linear-gradient(
      180deg,
      rgba(110, 110, 110, 0.55) 0%,
      rgba(75, 75, 75, 0.45) 20%,
      rgba(55, 55, 55, 0.5) 60%,
      rgba(45, 45, 45, 0.6) 100%
    );
  }

  .nav-tab-active .tab-bg {
    background: transparent;
  }

  /* ——— Bottom Marquee Pill ——— */
  .marquee-container {
    mask-image: linear-gradient(to right, transparent, black 20px, black calc(100% - 20px), transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black calc(100% - 20px), transparent);
  }

  .marquee-content {
    display: inline-flex;
    white-space: nowrap;
    animation: marquee-scroll 45s linear infinite;
  }

  @keyframes marquee-scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  /* ——— Dock (Projects / Profiles) - Magnetic Carousel ——— */
  .dock-item {
    /* GSAP controls transform - only transition visual properties */
    transition: background-color 0.2s, border-color 0.2s;
    transform-origin: center center;
    will-change: transform;
  }

  /* Hover on non-active items */
  .dock-item:not(.active):hover {
    z-index: 10;
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.15);
  }

  .dock-item:hover img {
    opacity: 1;
  }

  /* Sharp spotlight gradient on hover */
  .dock-item-gradient {
    background: radial-gradient(
      circle at 50% 30%,
      rgba(255, 255, 255, 0.25) 0%,
      rgba(255, 255, 255, 0.08) 30%,
      transparent 60%
    );
  }

  .dock-item.active .dock-item-gradient {
    opacity: 1;
  }

  /* Active state: GSAP handles scale + position, CSS handles visuals */
  .dock-item.active {
    z-index: 20 !important;
    background: linear-gradient(
      180deg,
      rgba(255, 255, 255, 0.22) 0%,
      rgba(255, 255, 255, 0.08) 30%,
      rgba(15, 15, 15, 0.95) 100%
    ) !important;
    border-color: rgba(255, 255, 255, 0.4) !important;
  }

  /* Magnetic glow ring - top highlight */
  .dock-item.active::before {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 20px;
    background: radial-gradient(
      ellipse 80% 40% at 50% 0%,
      rgba(255, 255, 255, 0.35) 0%,
      transparent 70%
    );
    pointer-events: none;
    z-index: -1;
  }

  /* Outer magnetic field aura */
  .dock-item.active::after {
    content: '';
    position: absolute;
    inset: -20px;
    border-radius: 32px;
    background: radial-gradient(
      circle at 50% 50%,
      rgba(255, 255, 255, 0.12) 0%,
      rgba(255, 255, 255, 0.04) 40%,
      transparent 70%
    );
    pointer-events: none;
    z-index: -2;
  }

  .dock-item.active:hover {
    border-color: rgba(255, 255, 255, 0.5) !important;
  }

  .dock-item.active .dock-item-gradient {
    opacity: 1;
  }

  /* Non-active items in carousel */
  .dock-item:not(.active) {
    z-index: 10;
  }

  /* Hide scrollbar on Projects sidebar (no visible bar) */
  .projects-dock-scroll,
  .profiles-dock-scroll {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .projects-dock-scroll::-webkit-scrollbar,
  .profiles-dock-scroll::-webkit-scrollbar {
    width: 0;
    height: 0;
    display: none;
    background: transparent;
  }

  .hide-scrollbar {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

  /* ——— Flashlight tabs (mouse-follow glow) ——— */
  .flashlight-tab {
    --mouse-x: 50%;
    --mouse-y: 50%;
    --glow-opacity: 0;
    position: relative;
    overflow: hidden;
    isolation: isolate;
  }

  .tab-bg {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.04);
    border-radius: inherit;
    z-index: 0;
    transition: background 0.2s ease;
  }

  .flashlight-tab:hover .tab-bg {
    background: rgba(255, 255, 255, 0.08);
  }

  .tab-glow {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: radial-gradient(
      120px circle at var(--mouse-x) var(--mouse-y),
      rgba(255, 255, 255, 0.15) 0%,
      rgba(255, 255, 255, 0.05) 40%,
      transparent 70%
    );
    opacity: var(--glow-opacity);
    transition: opacity 0.3s ease;
    z-index: 1;
    pointer-events: none;
  }

  .tab-content {
    position: relative;
    z-index: 2;
  }

  /* ——— Preview frame with corner markers aligned to 32px grid ——— */
  .preview-frame-wrapper {
    position: relative;
  }

  .preview-frame {
    border-radius: 0;
  }

  /* Corner dots - larger than background dots to mark frame corners on grid */
  .corner-dot {
    position: absolute;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    z-index: 20;
  }

  /* Position dots at exact corners */
  .corner-tl { top: -2px; left: -2px; }
  .corner-tr { top: -2px; right: -2px; }
  .corner-bl { bottom: -2px; left: -2px; }
  .corner-br { bottom: -2px; right: -2px; }

  /* Frame border lines - subtle but visible */
  .frame-line {
    position: absolute;
    background: rgba(255, 255, 255, 0.15);
    z-index: 15;
  }

  .frame-top {
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
  }

  .frame-bottom {
    bottom: 0;
    left: 0;
    right: 0;
    height: 1px;
  }

  .frame-left {
    top: 0;
    bottom: 0;
    left: 0;
    width: 1px;
  }

  .frame-right {
    top: 0;
    bottom: 0;
    right: 0;
    width: 1px;
  }

  /* ——— Vertical cards (Strategy / Identity / Design / Production) ——— */
  .vertical-card {
    padding: 1rem;
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.04);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }

  .vertical-card:not(.hidden) {
    animation: fadeInUp 0.4s ease forwards;
  }

  .vertical-card:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .vertical-card__label {
    display: block;
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 0.5rem;
  }

  .vertical-card__desc {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.4);
    margin: 0;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ——— Lab View Grid ——— */
  .lab-view {
    transition: opacity 0.3s ease;
  }

  .lab-view.hidden {
    display: none;
  }

  .stage-view {
    transition: opacity 0.3s ease;
  }

  .stage-view.hidden {
    display: none;
  }

  /* ——— About Modal ——— */
  #about-modal {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
  }

  #about-modal.active {
    opacity: 1;
    pointer-events: auto;
  }

  #about-modal.active .about-content {
    transform: translateY(0);
  }

  .about-content {
    transform: translateY(20px);
    transition: transform 0.4s ease;
  }

  .about-video-container {
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

</style>

<script>
  import gsap from 'gsap';

  // Flashlight tabs effect
  const flashlightTabs = document.querySelectorAll('.flashlight-tab');

  flashlightTabs.forEach(tab => {
    tab.addEventListener('mousemove', (e) => {
      const rect = tab.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      tab.style.setProperty('--mouse-x', `${x}px`);
      tab.style.setProperty('--mouse-y', `${y}px`);
      tab.style.setProperty('--glow-opacity', '1');
    });

    tab.addEventListener('mouseleave', () => {
      tab.style.setProperty('--glow-opacity', '0');
    });
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // ABOUT MODAL
  // ═══════════════════════════════════════════════════════════════════════════
  const aboutModal = document.getElementById('about-modal');
  const aboutTrigger = document.getElementById('about-trigger');
  const aboutClose = document.getElementById('about-close');
  const aboutVideo = aboutModal?.querySelector('video');

  function openAbout() {
    if (!aboutModal) return;
    aboutModal.classList.remove('hidden');
    // Small delay for CSS transition
    requestAnimationFrame(() => {
      aboutModal.classList.add('active');
    });
    // Play video
    aboutVideo?.play();
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
  }

  function closeAbout() {
    if (!aboutModal) return;
    aboutModal.classList.remove('active');
    // Wait for transition then hide
    setTimeout(() => {
      aboutModal.classList.add('hidden');
    }, 400);
    // Pause video
    aboutVideo?.pause();
    // Restore body scroll
    document.body.style.overflow = '';
  }

  aboutTrigger?.addEventListener('click', openAbout);
  aboutClose?.addEventListener('click', closeAbout);

  // Close on backdrop click
  aboutModal?.addEventListener('click', (e) => {
    if (e.target === aboutModal || (e.target as Element)?.classList.contains('about-backdrop')) {
      closeAbout();
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && aboutModal?.classList.contains('active')) {
      closeAbout();
    }
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // LAB / STAGE TOGGLE
  // ═══════════════════════════════════════════════════════════════════════════
  const labTab = document.getElementById('lab-tab');
  const stageTab = document.getElementById('stage-tab');
  const labView = document.getElementById('lab-view');
  const stageView = document.getElementById('stage-view');
  const pageContainer = document.getElementById('page-container');
  const dotGridEl = document.querySelector('.dot-grid');
  const watermarkDiv = document.querySelector('.watermark')?.parentElement;
  const watermarkImg = document.querySelector('.watermark') as HTMLElement;
  const heroImageDiv = document.getElementById('hero-media')?.parentElement;
  const gridFrameDiv = document.getElementById('grid-frame')?.parentElement;
  const bioSection = document.querySelector('.bio-section');
  const bottomCta = document.querySelector('.marquee-pill')?.parentElement;
  const contactBtn = document.querySelector('[href="mailto:hello@renaise.com"]')?.parentElement;
  const aboutBtn = document.querySelector('[href="#about"]')?.parentElement;
  const ellipsisBtn = document.getElementById('ellipsis-menu');

  let isToggleAnimating = false;

  function showLab() {
    if (isToggleAnimating) return;
    isToggleAnimating = true;

    labTab?.classList.add('nav-tab-active');
    stageTab?.classList.remove('nav-tab-active');

    // Show lab view immediately but transparent
    labView?.classList.remove('hidden');
    gsap.set(labView, { opacity: 0, x: -50 });

    // Timeline for flowing animation
    const tl = gsap.timeline({
      onComplete: () => { isToggleAnimating = false; }
    });


    // Stage elements ease out to the right (matches toggle direction)
    tl.to([stageView, heroImageDiv, gridFrameDiv, bioSection, bottomCta, contactBtn, aboutBtn], {
      opacity: 0,
      x: 50,
      duration: 0.4,
      ease: 'power2.out',
      stagger: 0.02,
      onComplete: () => {
        stageView?.classList.add('hidden');
        if (heroImageDiv) (heroImageDiv as HTMLElement).style.display = 'none';
        if (gridFrameDiv) (gridFrameDiv as HTMLElement).style.display = 'none';
        if (bioSection) (bioSection as HTMLElement).style.display = 'none';
        if (bottomCta) (bottomCta as HTMLElement).style.display = 'none';
        if (contactBtn) (contactBtn as HTMLElement).style.display = 'none';
        if (aboutBtn) (aboutBtn as HTMLElement).style.display = 'none';
      }
    }, 0);

    // Dot grid turns white for LAB
    tl.to(dotGridEl, {
      color: 'rgba(255, 255, 255, 0.6)',
      duration: 0.4,
      ease: 'power2.out',
    }, 0);

    // Background transitions
    tl.to(pageContainer, {
      background: 'linear-gradient(180deg, #9B9B9B 0%, #E3E3E3 100%)',
      duration: 0.6,
      ease: 'power2.out',
    }, 0.1);

    // Watermark to dark for light background
    if (watermarkImg) {
      tl.to(watermarkImg, {
        filter: 'brightness(0)',
        opacity: 1,
        duration: 0.4,
        ease: 'power2.out',
      }, 0.1);
    }

    // Ellipsis button to light mode
    ellipsisBtn?.classList.add('light');

    // Lab view eases in
    tl.to(labView, {
      opacity: 1,
      x: 0,
      duration: 0.5,
      ease: 'power2.out',
    }, 0.3);
  }

  function showStage() {
    if (isToggleAnimating) return;
    isToggleAnimating = true;

    labTab?.classList.remove('nav-tab-active');
    stageTab?.classList.add('nav-tab-active');

    // Show stage elements but transparent (watermark stays visible)
    stageView?.classList.remove('hidden');
    if (heroImageDiv) (heroImageDiv as HTMLElement).style.display = '';
    if (gridFrameDiv) (gridFrameDiv as HTMLElement).style.display = '';
    if (bioSection) (bioSection as HTMLElement).style.display = '';
    if (bottomCta) (bottomCta as HTMLElement).style.display = '';
    if (contactBtn) (contactBtn as HTMLElement).style.display = '';
    if (aboutBtn) (aboutBtn as HTMLElement).style.display = '';
    gsap.set([stageView, heroImageDiv, gridFrameDiv, bioSection, bottomCta, contactBtn, aboutBtn], { opacity: 0, x: 50 });

    // Timeline for flowing animation
    const tl = gsap.timeline({
      onComplete: () => { isToggleAnimating = false; }
    });

    // Lab view eases out
    tl.to(labView, {
      opacity: 0,
      x: -50,
      duration: 0.4,
      ease: 'power2.out',
      onComplete: () => {
        labView?.classList.add('hidden');
      }
    }, 0);

    // Background transitions
    tl.to(pageContainer, {
      background: '#111111',
      duration: 0.6,
      ease: 'power2.out',
    }, 0.1);

    // Watermark back to white for dark background
    if (watermarkImg) {
      tl.to(watermarkImg, {
        filter: 'brightness(0) invert(1)',
        opacity: 0.5,
        duration: 0.4,
        ease: 'power2.out',
      }, 0.1);
    }

    // Ellipsis button back to dark mode
    ellipsisBtn?.classList.remove('light');

    // Dot color transitions
    tl.to(dotGridEl, {
      color: 'rgba(255, 255, 255, 0.45)',
      duration: 0.6,
      ease: 'power2.out',
    }, 0.1);

    // Dot grid fades in
    tl.to(dotGridEl, {
      opacity: 1,
      duration: 0.5,
      ease: 'power2.out',
    }, 0.2);

    // Stage elements ease in (watermark stays visible)
    tl.to([stageView, heroImageDiv, gridFrameDiv, bioSection, bottomCta, contactBtn, aboutBtn], {
      opacity: 1,
      x: 0,
      duration: 0.5,
      ease: 'power2.out',
      stagger: 0.02,
    }, 0.3);

    stageTab?.classList.add('nav-tab-active');
    labTab?.classList.remove('nav-tab-active');

    // Show stage-specific elements
    if (bottomCta) (bottomCta as HTMLElement).style.display = '';
    if (contactBtn) (contactBtn as HTMLElement).style.display = '';
    if (aboutBtn) (aboutBtn as HTMLElement).style.display = '';
  }

  labTab?.addEventListener('click', showLab);
  stageTab?.addEventListener('click', showStage);

  // ═══════════════════════════════════════════════════════════════════════════
  // MAGNETIC CAROUSEL - The dock SPINS, active slot is fixed position
  // Items physically move through positions with magnetic snap/release physics
  // ═══════════════════════════════════════════════════════════════════════════

  const projectButtons = document.querySelectorAll('[data-project]');
  const previewIcon = document.getElementById('preview-icon');
  const projectPlatform = document.getElementById('project-platform');
  const dockContainer = document.querySelector('.projects-dock-scroll');
  const heroVideoEl = document.getElementById('hero-video') as HTMLVideoElement;
  const heroImageEl = document.getElementById('hero-image') as HTMLImageElement;

  // Get hero assets from window (passed from Astro)
  const heroAssets = (window as any).heroAssets || {};

  let currentOffset = 0; // Which item index is in the active slot
  let rotationInterval: ReturnType<typeof setInterval> | null = null;
  let isPaused = false;
  let isAnimating = false;
  const rotationDuration = 6000; // 6 seconds between spins

  const projectsArray = Array.from(projectButtons) as HTMLElement[];
  const itemCount = projectsArray.length;
  const itemHeight = 68; // Height of each dock item
  const itemGap = 12; // Gap between items
  const itemSpacing = itemHeight + itemGap; // Total space per item

  // The "active slot" is the 4th position (index 3) visually
  const activeSlotIndex = 3;

  // Magnetic easing curves
  const magneticRelease = "power3.in"; // Resist then break free
  const magneticSnapIn = "back.out(1.7)"; // Pulled in, overshoots, locks

  function getItemInActiveSlot(): HTMLElement {
    // The item currently in the active visual slot
    const visualIndex = (currentOffset + activeSlotIndex) % itemCount;
    return projectsArray[visualIndex];
  }

  function updateMarquee(project: Element) {
    const id = project.getAttribute('data-project');
    const name = project.getAttribute('data-name');
    const description = project.getAttribute('data-description');
    const category = project.getAttribute('data-category');
    const year = project.getAttribute('data-year');

    const marqueeContent = document.getElementById('marquee-content');
    if (marqueeContent) {
      const marqueeText = description || `${name} — ${category} — ${year}`;
      marqueeContent.innerHTML = `
        <span>${marqueeText}</span>
        <span class="mx-6">•</span>
        <span>${marqueeText}</span>
        <span class="mx-6">•</span>
        <span>${marqueeText}</span>
        <span class="mx-6">•</span>
      `;
    }

    // Update lab CTA link to point to this project
    const labCta = document.getElementById('lab-cta');
    if (labCta && id) {
      labCta.setAttribute('href', `/lab/${id}`);
    }
  }

  function updatePlatformIcon(icon: string) {
    if (!previewIcon || !icon) return;

    gsap.to(projectPlatform, {
      opacity: 0,
      scale: 0.95,
      duration: 0.15,
      ease: "power2.in",
      onComplete: () => {
        previewIcon.src = icon;
        gsap.to(projectPlatform, {
          opacity: 1,
          scale: 1,
          duration: 0.3,
          ease: magneticSnapIn
        });
      }
    });
  }

  function updateHeroMedia(projectId: string) {
    const asset = heroAssets[projectId];
    if (!asset) return;

    if (asset.type === 'video') {
      // Show video, hide image
      heroImageEl.classList.add('hidden');
      heroVideoEl.classList.remove('hidden');
      heroVideoEl.src = asset.url;
      heroVideoEl.play();
    } else {
      // Show image, hide video
      heroVideoEl.classList.add('hidden');
      heroVideoEl.pause();
      heroImageEl.classList.remove('hidden');
      heroImageEl.src = asset.url;
    }
  }

  function positionItems(animate = true) {
    // First pass: determine states
    const itemStates = projectsArray.map((item, index) => {
      let visualPosition = index - currentOffset;
      while (visualPosition < 0) visualPosition += itemCount;
      while (visualPosition >= itemCount) visualPosition -= itemCount;

      const yPos = visualPosition * itemSpacing;
      const isActive = visualPosition === activeSlotIndex;
      const wasActive = item.classList.contains('active');

      return { item, yPos, isActive, wasActive };
    });

    const incomingActive = itemStates.find(s => !s.wasActive && s.isActive);

    if (animate) {
      // ═══ ALL ITEMS: Move Y position together with same easing ═══
      itemStates.forEach(({ item, yPos }) => {
        gsap.to(item, {
          y: yPos,
          duration: 0.45,
          ease: "power2.inOut", // Smooth, synchronized movement
        });
      });

      // ═══ SCALE: Magnetic physics applied separately ═══
      itemStates.forEach(({ item, isActive, wasActive }) => {
        if (wasActive && !isActive) {
          // MAGNETIC RELEASE: resist then break free
          item.classList.remove('active');
          gsap.to(item, {
            scale: 1,
            duration: 0.5,
            ease: magneticRelease,
          });
        } else if (!wasActive && isActive) {
          // MAGNETIC SNAP-IN: pull in with overshoot
          item.classList.add('active');
          gsap.to(item, {
            scale: 1.3,
            duration: 0.5,
            ease: magneticSnapIn,
          });

          // Glow pulse on lock
          gsap.fromTo(item,
            { boxShadow: "0 0 0px rgba(255,255,255,0)" },
            {
              boxShadow: "0 0 40px rgba(255,255,255,0.4)",
              duration: 0.25,
              ease: "power2.out",
              yoyo: true,
              repeat: 1,
              delay: 0.2, // Pulse when it "locks" in
            }
          );
        }
      });

      // Update content
      if (incomingActive) {
        const icon = incomingActive.item.getAttribute('data-icon') || '';
        const projectId = incomingActive.item.getAttribute('data-project') || '';
        updateMarquee(incomingActive.item);
        updatePlatformIcon(icon);
        updateHeroMedia(projectId);
      }

    } else {
      // Immediate positioning
      itemStates.forEach(({ item, yPos, isActive }) => {
        gsap.set(item, { y: yPos, scale: isActive ? 1.3 : 1 });

        if (isActive) {
          item.classList.add('active');
          const icon = item.getAttribute('data-icon') || '';
          const projectId = item.getAttribute('data-project') || '';
          updateMarquee(item);
          if (previewIcon && icon) previewIcon.src = icon;
          updateHeroMedia(projectId);
        } else {
          item.classList.remove('active');
        }
      });
    }
  }

  function spinCarousel(direction: number = 1) {
    if (isAnimating) return;
    isAnimating = true;

    // Advance the offset (negative = items move up, next item enters from bottom)
    currentOffset = (currentOffset + direction + itemCount) % itemCount;

    positionItems(true);

    setTimeout(() => {
      isAnimating = false;
    }, 550);
  }

  function startRotation() {
    if (rotationInterval) clearInterval(rotationInterval);

    rotationInterval = setInterval(() => {
      if (!isPaused && !isAnimating) {
        spinCarousel(1);
      }
    }, rotationDuration);
  }

  function pauseRotation() {
    isPaused = true;
  }

  function resumeRotation() {
    isPaused = false;
  }

  // Manual project selection - spin to that project
  projectButtons.forEach((button, index) => {
    button.addEventListener('click', () => {
      const href = button.getAttribute('data-href');
      if (href && href !== '#') {
        window.open(href, '_blank');
      }
    });
  });

  // Pause on dock hover
  dockContainer?.addEventListener('mouseenter', pauseRotation);
  dockContainer?.addEventListener('mouseleave', () => {
    setTimeout(resumeRotation, 1000);
  });

  // Pause on platform hover
  projectPlatform?.addEventListener('mouseenter', pauseRotation);
  projectPlatform?.addEventListener('mouseleave', resumeRotation);

  // Initialize - position all items immediately, then start spinning
  positionItems(false);
  startRotation();

  // Cleanup
  window.addEventListener('beforeunload', () => {
    if (rotationInterval) clearInterval(rotationInterval);
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // GRID-ALIGNED FRAME - Snaps to 32px dot grid
  // ═══════════════════════════════════════════════════════════════════════════

  const gridFrame = document.getElementById('grid-frame');
  const heroMediaContainer = document.getElementById('hero-media');
  const snapGrid = 8; // 8px snap grid for precise centering
  const dotGrid = 32; // Visual dots are 32px apart

  function alignToGrid() {
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    // Frame dimensions (multiples of 8)
    const frameWidth = 896; // 112 * 8
    const frameHeight = 544; // 68 * 8

    // True center position for the frame's top-left corner
    const idealLeft = (vw - frameWidth) / 2;
    const idealTop = (vh - frameHeight) / 2;

    // Snap to 8px grid for precise centering
    const left = Math.round(idealLeft / snapGrid) * snapGrid;
    const top = Math.round(idealTop / snapGrid) * snapGrid;

    // Apply to frame
    if (gridFrame) {
      gridFrame.style.width = `${frameWidth}px`;
      gridFrame.style.height = `${frameHeight}px`;
      gridFrame.style.left = `${left}px`;
      gridFrame.style.top = `${top}px`;
    }

    // Apply same position to hero media
    if (heroMediaContainer) {
      heroMediaContainer.style.width = `${frameWidth}px`;
      heroMediaContainer.style.height = `${frameHeight}px`;
      heroMediaContainer.style.left = `${left}px`;
      heroMediaContainer.style.top = `${top}px`;
    }
  }

  alignToGrid();
  window.addEventListener('resize', alignToGrid);
</script>
